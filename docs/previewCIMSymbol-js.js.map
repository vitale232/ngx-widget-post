{"version":3,"sources":["./node_modules/@arcgis/core/symbols/support/previewCIMSymbol.js","./node_modules/@arcgis/core/geometry/support/quantizationUtils.js","./node_modules/@arcgis/core/symbols/cim/TextRasterizer.js","./node_modules/@arcgis/core/symbols/cim/CIMSymbolRasterizer.js"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACmM,YAAY,+EAAC,UAAU,uBAAuB,EAAE,MAAM,8EAA8E,KAAK,2EAAC,qCAAqC,kEAAC,OAAO,oBAAoB,2EAAC,MAAM,wBAAwB,GAAG,QAAQ,uEAAuE,iDAAiD,sBAAsB,qCAAqC,sDAAsD,iDAAiD,6BAA6B,wEAAwE,YAAY,gDAAgD,uBAAuB,wDAAwD,EAAE,yBAAuD;;;;;;;;;;;;;ACJ3/B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACwG,cAAc,yCAAyC,wEAAwE,cAAc,kBAAkB,OAAO,iMAAiM,gBAAgB,oCAAoC,6BAA6B,gBAAgB,uOAAuO,YAAY,oBAAoB,IAAI,iCAAiC,YAAY,oBAAoB,IAAI,iCAAiC,kBAAkB,WAAW,YAAY,YAAY,WAAW,KAAK,aAAa,sHAAsH,yBAAyB,kBAAkB,qEAAqE,oBAAoB,4BAA4B,oBAAoB,2BAA2B,YAAY,WAAW,KAAK,oBAAoB,0BAA0B,uBAAuB,oBAAoB,2BAA2B,YAAY,WAAW,KAAK,oBAAoB,0BAA0B,uBAAuB,YAAY,oBAAoB,IAAI,mBAAmB,YAAY,oBAAoB,IAAI,mBAAmB,kBAAkB,4BAA4B,sBAAsB,mBAAmB,kCAAkC,iBAAiB,YAAY,WAAW,KAAK,aAAa,kCAAkC,SAAS,kBAAkB,4BAA4B,YAAY,WAAW,qBAAqB,SAAS,kBAAkB,mHAAmH,oBAAoB,4BAA4B,oBAAoB,4BAA4B,oBAAoB,4BAA4B,kBAAkB,0FAA0F,YAAY,WAAW,KAAK,gBAAgB,mGAAmG,qCAAqC,gBAAgB,yBAAyB,sEAAsE,YAAY,WAAW,gBAAgB,SAAS,cAAc,8GAA8G,gBAAgB,cAAc,sBAAsB,cAAc,sBAAsB,sBAAsB,gKAAgK,sBAAsB,oCAAoC,sBAAsB,sEAAsE,sBAAsB,yBAAyB,4BAA4B,sBAAsB,yBAAyB,4BAA4B,gBAAgB,YAAY,6DAAC,UAAU,UAAU,gEAAC,UAAU,UAAU,+DAAC,UAAU,UAAU,kEAAC,UAAU,UAAU,8DAAC,UAAU,oBAAoB,sBAAsB,gKAAgK,sBAAsB,oCAAoC,sBAAsB,sEAAsE,sBAAsB,kCAAkC,sBAAsB,kCAAywB;;;;;;;;;;;;;ACJppJ;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACkD,QAAQ,eAAe,mBAAmB,gGAAgG,2DAA2D,uHAAuH,2EAA2E,MAAM,iOAAiO,kCAAkC,GAAG,KAAK,8BAA8B,aAAa,wBAAwB,GAAG,eAAe,wDAAwD,4BAA4B,sBAAsB,wCAAwC,uCAAuC,YAAY,4CAA4C,mNAAmN,4FAA4F,wBAAwB,MAAM,YAAY,WAAW,8DAA8D,OAAO,2HAA2H,wBAAwB,iDAAiD,6KAA6K,2DAA2D,yGAAyG,gCAAgC,sLAAsL,0BAA0B,wDAAwD,+BAA+B,6CAA6C,MAAM,wBAAwB,wDAAwD,+BAA+B,qBAAqB,YAAY,IAAI,KAAK,sBAAsB,oCAAoC,MAAM,uBAAuB,oBAAoB,QAAQ,GAAG,SAAS,GAAG,kEAAC,sBAAsB,KAAK,SAAS,cAAc,MAAM,4DAA4D,oBAAoB,MAAM,sBAAsB,MAAM,wBAAwB,MAAM,iBAAiB,cAAc,sBAAsB,QAAQ,mEAAmE,eAAe,6OAA6O,oBAAoB,mCAAmC,kDAAkD,YAAY,WAAW,YAAY,MAAM,mEAAkF,gEAAC,EAA6B;;;;;;;;;;;;;ACJ16G;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACuqB,MAAM,aAAa,sCAAsC,SAAS,GAAG,kBAAkB,oBAAoB,MAAM,MAAM,sEAAsE,eAAe,kEAAC,IAAI,oCAAoC,SAAS,wCAAwC,IAAI,MAAM,QAAQ,OAAO,8BAA8B,WAAW,8CAA8C,cAAc,gDAAgD,UAAU,OAAO,gCAAgC,WAAW,kDAAkD,cAAc,oDAAoD,SAAS,QAAQ,OAAO,8BAA8B,WAAW,8BAA8B,cAAc,+BAA+B,UAAU,OAAO,+BAA+B,WAAW,+BAA+B,cAAc,mCAAmC,QAAQ,iBAAiB,2FAA2F,sDAAC,0BAA0B,kEAAC,kCAAkC,+CAA+C,+CAA+C,kFAAC,gCAAgC,2CAA2C,2BAA2B,mEAAmE,iDAAiD,mDAAmD,qBAAqB,IAAI,oDAAoD,4BAA4B,mBAAmB,sFAAsF,IAAI,2BAA2B,4CAA4C,kCAAkC,gBAAgB,gEAAgE,MAAM,MAAM,MAAM,wEAAC,4BAA4B,4EAAC,IAAI,wPAAwP,6EAAC,2BAA2B,gBAAgB,iEAAC,MAAM,sCAAsC,uBAAuB,qCAAqC,eAAe,2DAAC,YAAY,wCAAwC,QAAQ,mCAAmC,gCAAgC,WAAW,kBAAkB,0EAA0E,iDAAiD,eAAe,mDAAmD,4BAA4B,oBAAoB,KAAK,yEAAC,yBAAyB,yEAAC,2CAA2C,yEAAC,+DAA+D,yBAAyB,KAAK,yEAAC,gFAAgF,iBAAiB,MAAM,iBAAiB,MAAM,YAAY,4DAA4D,eAAe,MAAM,mBAAmB,MAAM,sBAAsB,MAAM,cAAc,iBAAiB,uFAAuF,EAAE,8BAA8B,kBAAkB,8DAA8D,oBAAoB,WAAW,YAAY,WAAW,KAAK,oCAAoC,eAAe,uFAAuF,gBAAgB,kEAAC,kBAAkB,kEAAC,kCAAkC,MAAM,UAAU,0IAA0I,gFAAgF,wCAAwC,+CAA+C,kDAAkD,SAAS,qFAAqF,UAAU,yBAAyB,eAAe,YAAY,WAAW,KAAK,yJAAyJ,YAAY,kCAAkC,qBAAqB,kEAAC,aAAa,kEAAC,4FAA4F,qBAAqB,kEAAC,cAAc,kEAAC,aAAa,YAAY,4EAAC,EAAE,+BAA+B,EAAE,OAAO,kHAAkH,sBAAsB,gFAAgF,mDAAmD,iEAAiE,uBAAuB,gFAAgF,mDAAmD,wGAAwG,oCAAoC,YAAY,0DAA0D,uFAAuF,oBAAoB,kCAAkC,oCAAoC,QAAQ,yEAAC,gBAAgB,UAAU,QAAQ,yBAAyB,4EAA4E,YAAY,EAAE,qBAAqB,sDAAsD,2BAA2B,+CAA+C,8CAA8C,cAAc,yEAAC,gCAAgC,yEAAC,iCAAiC,yEAAC,6DAA6D,cAAc,eAAe,mEAAC,wEAAwE,KAAK,+BAA+B,oBAAoB,gIAAgI,iCAAiC,UAAU,oEAAoE,yBAAyB,gCAAgC,KAAK,EAAE,qBAAqB,aAAa,mEAAmE,kCAAkC,sDAAsD,2CAA2C,EAAE,qBAAqB,wDAAwD,KAAK,qEAAqE,EAAE,qBAAqB,aAAa,oBAAoB,oCAAoC,QAAQ,yEAAC,kBAAkB,yBAAyB,+BAA+B,UAAU,2HAA2H,GAAG,iFAAC,MAAM,wBAAwB,MAAM,+BAA+B,4BAA4B,8HAA8H,kCAAkC,sBAAsB,yEAAC,eAAe,gCAAgC,QAAQ,yEAAC,qBAAqB,yEAAC,kBAAkB,yEAAC,mBAAmB,yEAAC,uBAAuB,yEAAC,mBAAmB,yEAAC,gCAAgC,yEAAC,8BAA8B,8DAAC,CAAC,yEAAC,mBAAmB,8DAAC,CAAC,yEAAC,2BAA2B,+DAA+D,uCAAuC,OAAO,KAAK,yEAAC,yCAAyC,iDAAiD,+CAA+C,uCAAuC,8DAA8D,SAAS,kEAAC,0DAA0D,kEAAC,sCAAsC,+BAA+B,4CAA4C,2JAA2J,gBAAgB,6BAA6B,kEAAC,uBAAuB,kEAAC,mBAAmB,EAAE,sBAAsB,UAAU,gFAAC,qDAAqD,iFAAC,oHAAoH,kBAAkB,qBAAqB,QAAQ,WAAW,SAAS,kEAAC,OAAO,kEAAC,QAAQ,YAAY,IAAI,oBAAoB,kEAAC,OAAO,kEAAC,QAAQ,eAAe,aAAa,sEAAsE,OAAO,qGAAqG,yBAAyB,qDAAqD,kBAAkB,iCAAiC,kEAAC,IAAI,kEAAC,sBAAsB,kEAAC,MAAM,kEAAC,aAAa,OAAO,oDAAoD,kCAAkC,QAAQ,gFAAC,gDAAgD,OAAO,sDAAsD,oDAAoD,yBAAyB,IAAI,oBAAoB,QAAQ,sCAAsC,8BAA8B,0EAAC,4BAA4B,8BAA8B,OAAO,sBAA0E","file":"previewCIMSymbol-js.js","sourcesContent":["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.18/esri/copyright.txt for details.\n*/\nimport{px2pt as t}from\"../../core/screenUtils.js\";import{getCIMSymbolSize as e,scaleCIMSymbolTo as a}from\"./cimSymbolUtils.js\";import{CIMSymbolRasterizer as l}from\"../cim/CIMSymbolRasterizer.js\";const i=new l(null,!0);async function o(l,o={}){const{size:n,maxSize:s,feature:c,fieldMap:m,geometryType:r,style:y,node:d,opacity:h}=o,u=e(l),p=Math.min(null!=n?n:u,null!=s?s:t(120));p!==u&&(l=l.clone(),a(l,p,{preserveOutlineWidth:!0}));let g=3;l&&l.data&&l.data.symbol&&\"CIMPointSymbol\"!==l.data.symbol.type&&(g=1);const f=await i.rasterizeCIMSymbolAsync(l,c,m,r,{scaleFactor:g,style:y}),M=document.createElement(\"canvas\");M.width=f.imageData.width,M.height=f.imageData.height;M.getContext(\"2d\").putImageData(f.imageData,0,0);let b=M.width/g,w=M.height/g;if(null!=n&&(null==(null==o?void 0:o.scale)||(null==o?void 0:o.scale))){const t=b/w;b=t<=1?Math.ceil(p*t):p,w=t<=1?p:Math.ceil(p/t)}const C=new Image(b,w);return C.src=M.toDataURL(),null!=h&&(C.style.opacity=`${h}`),d&&d.appendChild(C),C}export{o as previewCIMSymbol};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.18/esri/copyright.txt for details.\n*/\nimport{isPoint as n,isPolyline as t,isPolygon as r,isMultipoint as e,isExtent as u}from\"./jsonUtils.js\";function i(n){return n&&\"upperLeft\"===n.originPosition}const o=(n,t,r)=>[t,r],l=(n,t,r)=>[t,r,n[2]],a=(n,t,r)=>[t,r,n[2],n[3]];function m(n){if(!n)return null;return{originPosition:\"upper-left\"===n.originPosition?\"upperLeft\":\"lower-left\"===n.originPosition?\"lowerLeft\":n.originPosition,scale:[n.tolerance,n.tolerance],translate:[n.extent.xmin,n.extent.ymax]}}function c(n,t){if(n===t||null==n&&null==t)return!0;if(null==n||null==t)return!1;let r,e,u,o,l,a;return i(n)?(r=n.translate[0],e=n.translate[1],u=n.scale[0]):(r=n.extent.xmin,e=n.extent.ymax,u=n.tolerance),i(t)?(o=t.translate[0],l=t.translate[1],a=t.scale[0]):(o=t.extent.xmin,l=t.extent.ymax,a=t.tolerance),r===o&&e===l&&u===a}function s({scale:n,translate:t},r){return Math.round((r-t[0])/n[0])}function f({scale:n,translate:t},r){return Math.round((t[1]-r)/n[1])}function x(n,t,r){const e=[];let u,i,o,l;for(let a=0;a<r.length;a++){const m=r[a];a>0?(o=s(n,m[0]),l=f(n,m[1]),o===u&&l===i||(e.push(t(m,o-u,l-i)),u=o,i=l)):(u=s(n,m[0]),i=f(n,m[1]),e.push(t(m,u,i)))}return e.length>0?e:null}function h(n,t,r){return t[0]=s(n,r[0]),t[3]=f(n,r[1]),t[2]=s(n,r[2]),t[1]=f(n,r[3]),t}function I(n,t,r,e){return x(n,r?e?a:l:e?l:o,t)}function g(n,t,r,e){const u=[],i=r?e?a:l:e?l:o;for(let r=0;r<t.length;r++){const e=x(n,i,t[r]);e&&e.length>=3&&u.push(e)}return u.length?u:null}function N(n,t,r,e){const u=[],i=r?e?a:l:e?l:o;for(let r=0;r<t.length;r++){const e=x(n,i,t[r]);e&&e.length>=2&&u.push(e)}return u.length?u:null}function p({scale:n,translate:t},r){return r*n[0]+t[0]}function y({scale:n,translate:t},r){return t[1]-r*n[1]}function z(n,t,r){const e=new Array(r.length);if(!r.length)return e;const[u,i]=n.scale;let o=p(n,r[0][0]),l=y(n,r[0][1]);e[0]=t(r[0],o,l);for(let n=1;n<r.length;n++){const a=r[n];o+=a[0]*u,l-=a[1]*i,e[n]=t(a,o,l)}return e}function T(n,t,r){const e=new Array(r.length);for(let u=0;u<r.length;u++)e[u]=z(n,t,r[u]);return e}function M(n,t,r){return r?(t[0]=p(n,r[0]),t[1]=y(n,r[3]),t[2]=p(n,r[2]),t[3]=y(n,r[1]),t):[p(n,t[0]),y(n,t[3]),p(n,t[2]),y(n,t[1])]}function E(n,t,r,e){return z(n,r?e?a:l:e?l:o,t)}function P(n,t,r,e){return T(n,r?e?a:l:e?l:o,t)}function b(n,t,r,e){return T(n,r?e?a:l:e?l:o,t)}function F(n,t,r){let[e,u]=r[0],i=Math.min(e,t[0]),o=Math.min(u,t[1]),l=Math.max(e,t[2]),a=Math.max(u,t[3]);for(let n=1;n<r.length;n++){const[t,m]=r[n];e+=t,u+=m,t<0&&(i=Math.min(i,e)),t>0&&(l=Math.max(l,e)),m<0?o=Math.min(o,u):m>0&&(a=Math.max(a,u))}return n[0]=i,n[1]=o,n[2]=l,n[3]=a,n}function V(n,t){if(!t.length)return null;n[0]=n[1]=Number.POSITIVE_INFINITY,n[2]=n[3]=Number.NEGATIVE_INFINITY;for(let r=0;r<t.length;r++)F(n,n,t[r]);return n}function Y(n){const t=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];return F(t,t,n)}function _(n){return V([0,0,0,0],n)}function A(n){return V([0,0,0,0],n)}function w(n,t,r,e,u){return t.xmin=s(n,r.xmin),t.ymin=f(n,r.ymin),t.xmax=s(n,r.xmax),t.ymax=f(n,r.ymax),t!==r&&(e&&(t.zmin=r.zmin,t.zmax=r.zmax),u&&(t.mmin=r.mmin,t.mmax=r.mmax)),t}function G(n,t,r,e,u){return t.points=I(n,r.points,e,u),t}function L(n,t,r,e,u){return t.x=s(n,r.x),t.y=f(n,r.y),t!==r&&(e&&(t.z=r.z),u&&(t.m=r.m)),t}function O(n,t,r,e,u){const i=g(n,r.rings,e,u);return i?(t.rings=i,t):null}function S(n,t,r,e,u){const i=N(n,r.paths,e,u);return i?(t.paths=i,t):null}function d(i,o){return i&&o?n(o)?L(i,{},o,!1,!1):t(o)?S(i,{},o,!1,!1):r(o)?O(i,{},o,!1,!1):e(o)?G(i,{},o,!1,!1):u(o)?w(i,{},o,!1,!1):null:null}function j(n,t,r,e,u){return t.xmin=p(n,r.xmin),t.ymin=y(n,r.ymin),t.xmax=p(n,r.xmax),t.ymax=y(n,r.ymax),t!==r&&(e&&(t.zmin=r.zmin,t.zmax=r.zmax),u&&(t.mmin=r.mmin,t.mmax=r.mmax)),t}function U(n,t,r,e,u){return t.points=E(n,r.points,e,u),t}function k(n,t,r,e,u){return t.x=p(n,r.x),t.y=y(n,r.y),t!==r&&(e&&(t.z=r.z),u&&(t.m=r.m)),t}function q(n,t,r,e,u){return t.rings=b(n,r.rings,e,u),t}function v(n,t,r,e,u){return t.paths=P(n,r.paths,e,u),t}export{c as equals,F as getQuantizedBoundsCoordsArray,V as getQuantizedBoundsCoordsArrayArray,_ as getQuantizedBoundsPaths,Y as getQuantizedBoundsPoints,A as getQuantizedBoundsRings,h as quantizeBounds,w as quantizeExtent,d as quantizeGeometry,G as quantizeMultipoint,N as quantizePaths,L as quantizePoint,I as quantizePoints,O as quantizePolygon,S as quantizePolyline,g as quantizeRings,s as quantizeX,f as quantizeY,m as toQuantizationTransform,M as unquantizeBounds,z as unquantizeCoordsArray,T as unquantizeCoordsArrayArray,j as unquantizeExtent,U as unquantizeMultipoint,P as unquantizePaths,k as unquantizePoint,E as unquantizePoints,q as unquantizePolygon,v as unquantizePolyline,b as unquantizeRings,p as unquantizeX,y as unquantizeY};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.18/esri/copyright.txt for details.\n*/\nimport{pt2px as t}from\"../../core/screenUtils.js\";class e{constructor(){}rasterizeText(t,e){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement(\"canvas\"));const i=this._textRasterizationCanvas,s=i.getContext(\"2d\");this.setFontProperties(s,e),this.parameters=e,this.textLines=t.split(/\\r?\\n/),this.lineHeight=this.computeLineHeight();const r=this.computeTextWidth(s,e),o=this.lineHeight*this.textLines.length;var n;i.width=r,i.height=o,this.renderedLineHeight=Math.round(this.lineHeight*e.pixelRatio),this.renderedHaloSize=e.halo.size*e.pixelRatio,this.renderedWidth=r*e.pixelRatio,this.renderedHeight=o*e.pixelRatio,this.fillStyle=`rgba(${(n=e.color).slice(0,3).toString()},${n[3]})`,this.haloStyle=function(t){return`rgb(${t.slice(0,3).toString()})`}(e.halo.color);const a=this.renderedLineHeight,h=this.renderedHaloSize;this.setFontProperties(s,e);const l=function(t,e){return\"center\"===t?.5*e:\"right\"===t?e:0}(s.textAlign,this.renderedWidth)+h,d=h;let c=0,g=0;h>0&&this.renderHalo(s,l,d,c,g,e),g+=d,c+=l;for(const t of this.textLines)s.globalCompositeOperation=\"destination-out\",s.fillStyle=\"rgb(0, 0, 0)\",s.fillText(t,c,g),s.globalCompositeOperation=\"source-over\",s.fillStyle=this.fillStyle,s.fillText(t,c,g),g+=a;const f=s.getImageData(0,0,this.renderedWidth,this.renderedHeight),p=new Uint8Array(f.data);if(e.premultiplyColors){let t;for(let e=0;e<p.length;e+=4)t=p[e+3]/255,p[e]=p[e]*t,p[e+1]=p[e+1]*t,p[e+2]=p[e+2]*t}return{size:[this.renderedWidth,this.renderedHeight],image:new Uint32Array(p.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}renderHalo(t,e,i,s,r,o){const n=this.renderedWidth,a=this.renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement(\"canvas\")),this._haloRasterizationCanvas.width=n,this._haloRasterizationCanvas.height=a;const h=this._haloRasterizationCanvas,l=h.getContext(\"2d\");l.clearRect(0,0,n,a),this.setFontProperties(l,o),l.fillStyle=this.haloStyle,l.strokeStyle=this.haloStyle;const d=this.renderedHaloSize<3;l.lineJoin=d?\"miter\":\"round\",d?this.renderHaloEmulated(l,e,i):this.renderHaloNative(l,e,i),t.globalAlpha=this.parameters.halo.color[3],t.drawImage(h,0,0,n,a,s,r,n,a),t.globalAlpha=1}renderHaloEmulated(t,e,s){const r=this.renderedLineHeight,o=this.renderedHaloSize;for(const n of this.textLines){for(const[r,a]of i)t.fillText(n,e+o*r,s+o*a);s+=r}}renderHaloNative(t,e,i){const s=this.renderedLineHeight,r=this.renderedHaloSize;for(const o of this.textLines){const n=2*r,a=5,h=.1;for(let s=0;s<a;s++){const r=1-(a-1)*h+s*h;t.lineWidth=r*n,t.strokeText(o,e,i)}i+=s}}setFontProperties(e,i){const s=i.font,r=`${s.style} ${s.weight} ${t(i.size*i.pixelRatio)}px ${s.family}, sans-serif`;let o;switch(e.font=r,e.textBaseline=\"top\",i.horizontalAlignment){case\"left\":o=\"left\";break;case\"right\":o=\"right\";break;case\"center\":o=\"center\";break;default:o=\"left\"}e.textAlign=o}computeTextWidth(t,e){let i=0;for(const e of this.textLines)i=Math.max(i,t.measureText(e).width);const s=e.font;return(\"italic\"===s.style||\"oblique\"===s.style||\"string\"==typeof s.weight&&(\"bold\"===s.weight||\"bolder\"===s.weight)||\"number\"==typeof s.weight&&s.weight>600)&&(i+=.3*t.measureText(\"A\").width),i+=2*this.parameters.halo.size,Math.round(i)}computeLineHeight(){const t=1.275*this.parameters.size;return Math.round(t+2*this.parameters.halo.size)}}const i=[];{const t=16;for(let e=0;e<360;e+=360/t)i.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)])}export default e;export{e as TextRasterizer};\n","/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.18/esri/copyright.txt for details.\n*/\nimport{numericHash as e}from\"../../core/string.js\";import{throwIfAborted as t,all as r}from\"../../core/promiseUtils.js\";import{getJsonType as a,isPolygon as i,isPolyline as s}from\"../../geometry/support/jsonUtils.js\";import{pt2px as o}from\"../../core/screenUtils.js\";import n from\"../support/Symbol3DAnchorPosition2D.js\";import c from\"../../request.js\";import{createLabelOverrideFunction as l,evaluateValueOrFunction as m,colorToArray as h}from\"./utils.js\";import{scaleCIMMarker as f}from\"../support/cimSymbolUtils.js\";import{analyzeCIMSymbol as g,analyzeCIMResource as y}from\"./cimAnalyzer.js\";import u from\"./Rasterizer.js\";import{TextRasterizer as p}from\"./TextRasterizer.js\";var d;!function(e){e.Legend=\"legend\",e.Preview=\"preview\"}(d||(d={}));const M=(e,t,r)=>{if(e&&e.targetSize){let a;if(r){const t=Math.max(r.frame.xmax-r.frame.xmin,r.frame.ymax-r.frame.ymin);a=e.targetSize/o(t)}else a=e.targetSize/t.referenceSize;return a}return e&&e.scaleFactor?e.scaleFactor:1},C={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};class I{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._rasterizer=new u,this._textRasterizer=new p,this._pictureMarkerCache=new Map}async rasterizeCIMSymbolAsync(e,t,r,i,s,o,n,c){i=i||(t?null!=t.centroid?\"esriGeometryPolygon\":a(t.geometry):null)||function(e){if(!(e&&e.data&&e.data.symbol))return null;switch(e.data.symbol.type){case\"CIMPointSymbol\":case\"CIMTextSymbol\":return\"esriGeometryPoint\";case\"CIMLineSymbol\":return\"esriGeometryPolyline\";case\"CIMPolygonSymbol\":return\"esriGeometryPolygon\";default:return null}}(e);const l=await this.analyzeCIMSymbol(e,t?function(e){const t=e?Object.keys(e):[];return t.map((t=>({name:t,alias:t,type:\"string\"==typeof e[t]?\"esriFieldTypeString\":\"esriFieldTypeDouble\"})))}(t.attributes):null,r,i,c);return this.rasterizeCIMSymbol(l,t,i,s,o,n)}async analyzeCIMSymbol(e,a,i,s,o){const n=[],c=a?{geometryType:s,spatialReference:this._spatialReference,fields:a}:null;let m;await g(e.data,c,n,this._avoidSDF),t(o);for(const e of n)\"CIMPictureMarker\"!==e.cim.type&&\"CIMPictureFill\"!==e.cim.type&&\"CIMPictureStroke\"!==e.cim.type||(m||(m=[]),m.push(this.fetchPictureMarkerResource(e,o))),i&&\"text\"===e.type&&\"string\"==typeof e.text&&e.text.indexOf(\"[\")>-1&&(e.text=l(i,e.text,e.cim.textCase));return m&&await r(m),n}async fetchPictureMarkerResource(e,t){const r=e.materialHash;if(!this._pictureMarkerCache.get(r)){const a=(await c(e.cim.url,{responseType:\"image\",signal:t&&t.signal})).data;this._pictureMarkerCache.set(r,a)}}rasterizeCIMSymbol(e,t,r,a,i,s){const o=[];for(const n of e){a&&\"function\"==typeof a.scaleFactor&&(a.scaleFactor=a.scaleFactor(t,i,s));const e=this._getRasterizedResource(n,t,r,a,i,s);if(!e)continue;let c=0,l=e.anchorX||0,h=e.anchorY||0,f=!1,g=0,y=0;if(\"esriGeometryPoint\"===r){const e=M(a,n,null);if(g=m(n.offsetX,t,i,s)*e||0,y=m(n.offsetY,t,i,s)*e||0,\"marker\"===n.type)c=m(n.rotation,t,i,s)||0,f=!!n.rotateClockwise&&n.rotateClockwise;else if(\"text\"===n.type){if(c=m(n.angle,t,i,s)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case\"left\":l=-.5;break;case\"right\":l=.5;break;default:l=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case\"top\":h=.5;break;case\"bottom\":h=-.5;break;case\"baseline\":h=-.25;break;default:h=0}}}null!=e&&o.push({angle:c,rotateClockWise:f,anchorX:l,anchorY:h,offsetX:g,offsetY:y,rasterizedResource:e})}return this.getSymbolImage(o)}getSymbolImage(e){const t=document.createElement(\"canvas\"),r=t.getContext(\"2d\");let a=0,i=0,s=0,c=0;const l=[];for(let t=0;t<e.length;t++){const n=e[t],m=n.rasterizedResource;if(!m)continue;const h=m.size,f=n.offsetX,g=n.offsetY,y=n.anchorX,u=n.anchorY,p=n.rotateClockWise||!1;let d=n.angle,M=o(f)-h[0]*(.5+y),C=o(g)-h[1]*(.5+u),I=M+h[0],z=C+h[1];if(d){p&&(d=-d);const e=Math.sin(d*Math.PI/180),t=Math.cos(d*Math.PI/180),r=M*t-C*e,a=M*e+C*t,i=M*t-z*e,s=M*e+z*t,o=I*t-z*e,n=I*e+z*t,c=I*t-C*e,l=I*e+C*t;M=Math.min(r,i,o,c),C=Math.min(a,s,n,l),I=Math.max(r,i,o,c),z=Math.max(a,s,n,l)}a=M<a?M:a,i=C<i?C:i,s=I>s?I:s,c=z>c?z:c;const x=r.createImageData(m.size[0],m.size[1]);x.data.set(new Uint8ClampedArray(m.image.buffer));const P={offsetX:f,offsetY:g,rotateClockwise:p,angle:d,rasterizedImage:x,anchorX:y,anchorY:u};l.push(P)}t.width=s-a,t.height=c-i;const m=-a,h=c;for(let e=0;e<l.length;e++){const t=l[e],a=this._imageDataToCanvas(t.rasterizedImage),i=t.rasterizedImage.width,s=t.rasterizedImage.height,n=m-i*(.5+t.anchorX),c=h-s*(.5-t.anchorY);if(t.angle){const e=(360-t.angle)*Math.PI/180;r.save(),r.translate(o(t.offsetX),-o(t.offsetY)),r.translate(m,h),r.rotate(e),r.translate(-m,-h),r.drawImage(a,n,c),r.restore()}else r.drawImage(a,n+o(t.offsetX),c-o(t.offsetY))}const f=new n({x:m/t.width-.5,y:h/t.height-.5});return{imageData:0!==t.width&&0!==t.height?r.getImageData(0,0,t.width,t.height):r.createImageData(1,1),anchorPosition:f}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\"));const t=this._imageDataCanvas,r=t.getContext(\"2d\");return t.width=e.width,t.height=e.height,r.putImageData(e,0,0),t}_imageTo32Array(e,t,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement(\"canvas\"));const a=this._imageDataCanvas,i=a.getContext(\"2d\");return a.width=t,a.height=r,i.drawImage(e,0,0,t,r),new Uint32Array(i.getImageData(0,0,t,r).data.buffer)}_getRasterizedResource(t,r,a,i,s,o){let n,c,l,h;if(\"esriGeometryPolyline\"===a||\"esriGeometryPolygon\"===a){const h=i&&i.style?i.style:d.Legend,f=\"esriGeometryPolyline\"===a?C.stroke[h]:C.fill[h];if(\"line\"===t.type){if(\"CIMSolidStroke\"!==t.cim.type){if(\"CIMPictureStroke\"===t.cim.type){const e=m(t.width,r,s,o);let a,i,n;return({image:a,width:i,height:n}=this._getPictureResource(t,e)),this._rasterizePictureResource(t,a,i,n,f,e)}return null}({analyzedCIM:n,hash:l}=z(t,r,s,o)),c=this._embedCIMLayerInVectorMarker(n,f)}else if(\"marker\"===t.type){if(\"CIMPictureMarker\"===t.cim.type)return null;if(\"CIMVectorMarker\"!==t.cim.type)return null;t.cim.offsetX=m(t.offsetX,r,s,o),t.cim.offsetY=m(t.offsetY,r,s,o),t.cim.rotation=m(t.rotation,r,s,o),t.cim.markerPlacement=t.markerPlacement,({analyzedCIM:n}=z(t,r,s,o)),l=e(JSON.stringify(n)).toString(),c=this._embedCIMLayerInVectorMarker(n,f)}else{if(\"text\"===t.type)return null;if(\"fill\"===t.type){if(\"CIMHatchFill\"===t.cim.type||\"CIMVectorMarker\"===t.cim.type||\"CIMPictureMarker\"===t.cim.type||\"CIMPictureFill\"===t.cim.type){const e=t.cim.size||t.cim.height;let a,i,c;if(\"CIMPictureMarker\"===t.cim.type||\"CIMPictureFill\"===t.cim.type)({image:a,width:i,height:c}=this._getPictureResource(t,e));else{({analyzedCIM:n,hash:l}=z(t,r,s,o));const e=this._rasterizer.rasterizeJSONResource(n,1,this._avoidSDF);a=e.image,i=e.size[0],c=e.size[1]}return this._rasterizePictureResource(t,a,i,c,f,null)}if(\"CIMSolidFill\"!==t.cim.type)return null;({analyzedCIM:n,hash:l}=z(t,r,s,o)),c=this._embedCIMLayerInVectorMarker(n,f)}}}else{if(\"text\"===t.type)return h=this._rasterizeTextResource(t,r,i,s,o),h;({analyzedCIM:n,hash:l}=z(t,r,s,o));const e=M(i,t,null);if(\"CIMPictureMarker\"===t.cim.type){const a=m(t.size,r,s,o)*e,{image:i,width:n,height:c}=this._getPictureResource(t,a);return h={image:i,size:[n,c],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},h}f(n,e,{preserveOutlineWidth:!1}),c=n}l+=a,i&&(l+=JSON.stringify(i));const g=this._resourceCache;return g.has(l)?g.get(l):(h=this._rasterizer.rasterizeJSONResource(c,window.devicePixelRatio||1,this._avoidSDF),g.set(l,h),h)}_rasterizeTextResource(e,t,r,a,i){const s=M(r,e,null),o=m(e.text,t,a,i);if(!o||0===o.length)return null;const n=m(e.fontName,t,a,i),c=m(e.style,t,a,i),l=m(e.weight,t,a,i),f=m(e.decoration,t,a,i),g=m(e.size,t,a,i)*s,y=m(e.horizontalAlignment,t,a,i),u=m(e.verticalAlignment,t,a,i),p=h(m(e.color,t,a,i)),d=h(m(e.outlineColor,t,a,i)),C={color:p,size:g,horizontalAlignment:y,verticalAlignment:u,font:{family:n,style:c,weight:l,decoration:f},halo:{size:m(e.outlineSize,t,a,i)||0,color:d,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,C)}_rasterizePictureResource(e,t,r,a,n,c){const l=document.createElement(\"canvas\"),m=l.getContext(\"2d\");l.height=o(Math.max(Math.abs(n.frame.ymax-n.frame.ymin),c)),l.width=o(Math.abs(n.frame.xmax-n.frame.xmin));const h=m.createImageData(r,a);h.data.set(new Uint8ClampedArray(t.buffer));const f=this._imageDataToCanvas(h),g=m.createPattern(f,\"repeat\"),y=Math.cos((-e.cim.rotation||0)*Math.PI/180),u=Math.sin((-e.cim.rotation||0)*Math.PI/180);g.setTransform({m11:y,m12:u,m21:-u,m22:y,m41:o(e.cim.offsetX)||0,m42:o(e.cim.offsetY)||0});const p=n.canvasPaths;let d,M,C;i(p)?(d=p.rings,m.fillStyle=g,M=m.fill,C=[\"evenodd\"]):s(p)&&(d=p.paths,m.strokeStyle=g,m.lineWidth=c,M=m.stroke,d[0][0][1]=l.height/2,d[0][1][1]=l.height/2),m.beginPath();for(const e of d){const t=e?e.length:0;if(t>1){let r=e[0];m.moveTo(o(r[0]),o(r[1]));for(let a=1;a<t;++a)r=e[a],m.lineTo(o(r[0]),o(r[1]));m.closePath()}}M.apply(m,C);const I=m.getImageData(0,0,l.width,l.height),z=new Uint8Array(I.data);return{size:[l.width,l.height],image:new Uint32Array(z.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}}_getPictureResource(e,t){const r=this._pictureMarkerCache.get(e.materialHash);if(!r)return null;const a=r.height/r.width,i=t?a>1?o(t):o(t)/a:r.width,s=t?a>1?o(t)*a:o(t):r.height;return{image:this._imageTo32Array(r,i,s),width:i,height:s}}_embedCIMLayerInVectorMarker(e,t){const r=i(t.geometry)?\"CIMPolygonSymbol\":\"CIMLineSymbol\";return{type:\"CIMVectorMarker\",frame:t.frame,markerGraphics:[{type:\"CIMMarkerGraphic\",geometry:t.geometry,symbol:{type:r,symbolLayers:[e]}}]}}}function z(e,t,r,a){let i,s;if(\"function\"==typeof e.materialHash){i=(0,e.materialHash)(t,r,a),s=y(e.cim,e.materialOverrides)}else i=e.materialHash,s=e.cim;return{analyzedCIM:s,hash:i}}export{I as CIMSymbolRasterizer,d as GeometryStyle};\n"],"sourceRoot":"webpack:///"}